package e2e_generated

import (
	"context"
	"os/exec"
	"time"

	. "github.com/onsi/ginkgo/v2"
	. "github.com/onsi/gomega"
)

// Auto-generated by docsyncer from: testdata/markdown/multi-step.md
// Source type: markdown
// DO NOT EDIT â€” this file is regenerated on every run.

var _ = Describe("Multi-Step E2E Workflow", func() {
	Context("Prerequisites", func() {

		It("Infrastructure provisioning", func() {
			{
				By("Install PostgreSQL via Helm")
				dur, err := time.ParseDuration("30s")
				Expect(err).ToNot(HaveOccurred())
				ctx, cancel := context.WithTimeout(context.Background(), dur)
				defer cancel()
				cmd := exec.CommandContext(ctx, "helm", "install", "postgres", "bitnami/postgresql", "--set", "auth.postgresPassword=testpass")
				output, err := cmd.CombinedOutput()
				Expect(err).ToNot(HaveOccurred(), string(output))
			}
			{
				By("kubectl wait")
				dur, err := time.ParseDuration("120s")
				Expect(err).ToNot(HaveOccurred())
				ctx, cancel := context.WithTimeout(context.Background(), dur)
				defer cancel()
				cmd := exec.CommandContext(ctx, "kubectl", "wait", "--for=condition=ready", "pod", "-l", "app.kubernetes.io/name=postgresql", "--timeout=180s")
				output, err := cmd.CombinedOutput()
				Expect(err).ToNot(HaveOccurred(), string(output))
			}
		})

		It("Application deployment", func() {
			{
				By("Build Docker image")
				dur, err := time.ParseDuration("30s")
				Expect(err).ToNot(HaveOccurred())
				ctx, cancel := context.WithTimeout(context.Background(), dur)
				defer cancel()
				cmd := exec.CommandContext(ctx, "docker", "build", "-t", "myapp:e2e-test", ".")
				output, err := cmd.CombinedOutput()
				Expect(err).ToNot(HaveOccurred(), string(output))
			}
			{
				By("kubectl apply")
				dur, err := time.ParseDuration("30s")
				Expect(err).ToNot(HaveOccurred())
				ctx, cancel := context.WithTimeout(context.Background(), dur)
				defer cancel()
				cmd := exec.CommandContext(ctx, "kubectl", "apply", "-f", "./k8s/")
				output, err := cmd.CombinedOutput()
				Expect(err).ToNot(HaveOccurred(), string(output))
			}
			{
				By("Check application health endpoint")
				dur, err := time.ParseDuration("30s")
				Expect(err).ToNot(HaveOccurred())
				ctx, cancel := context.WithTimeout(context.Background(), dur)
				defer cancel()
				cmd := exec.CommandContext(ctx, "curl", "-f", "http://localhost:8080/healthz")
				output, err := cmd.CombinedOutput()
				Expect(err).ToNot(HaveOccurred(), string(output))
			}
		})
	})
})
